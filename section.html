<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif;
            padding: 0; margin: 0; background: transparent; color: inherit; overflow: visible; 
        }

        #main-content { padding-bottom: 50px; } /* Extra space for dropdowns */

        .item { 
            display: flex; align-items: center; padding: 2px 8px; position: relative; min-height: 32px;
        }
        .item:hover { background: rgba(255,255,255,0.08); border-radius: 3px; }
        .indent { margin-left: 24px; border-left: 2px solid #5e6c84; }

        input[type="checkbox"] { cursor: pointer; margin-right: 12px; width: 16px; height: 16px; flex-shrink: 0; }

        .task-input { 
            border: none; background: transparent; flex: 1; padding: 4px 0; 
            color: inherit; font-size: 14px; outline: none; min-width: 0;
        }

        /* Action Bar */
        .item-controls {
            display: flex; align-items: center; opacity: 0; transition: opacity 0.15s;
            margin-left: 4px; flex-shrink: 0;
        }
        .item:hover .item-controls { opacity: 1; }

        .control-wrapper {
            position: relative; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-left: 4px;
        }

        /* Avatar Styling */
        .avatar {
            width: 22px; height: 22px; border-radius: 50%;
            background: #dfe1e6; display: flex; align-items: center;
            justify-content: center; font-size: 10px; font-weight: bold;
            color: #172b4d; overflow: hidden; object-fit: cover; border: 1px solid rgba(0,0,0,0.1);
        }

        /* Member Picker Dropdown */
        .member-menu {
            position: absolute; top: 28px; right: 0; z-index: 1000;
            background: #ffffff; border-radius: 3px; 
            box-shadow: 0 8px 16px -4px rgba(9, 30, 66, 0.25), 0 0 0 1px rgba(9, 30, 66, 0.08);
            width: 200px; padding: 4px 0; color: #172b4d;
        }
        .member-option {
            display: flex; align-items: center; padding: 8px 12px; cursor: pointer;
        }
        .member-option:hover { background: #f4f5f7; }
        .member-option .avatar { margin-right: 10px; flex-shrink: 0; }
        .member-name { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Icon styling */
        .star-icon { color: #f2d600; font-size: 16px; }
        .date-icon { font-size: 16px; }

        /* Hidden Date Input stacked over icon */
        .date-input-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; z-index: 2;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            margin: 0; padding: 0; cursor: pointer;
        }

        .delete-btn { font-size: 16px; opacity: 0.7; }
        .delete-btn:hover { opacity: 1; }

        .footer { padding: 8px; display: flex; gap: 8px; }
        .hidden { display: none !important; }
        
        button { 
            background: rgba(255,255,255,0.1); border: none; color: inherit; 
            padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 14px;
        }
        button:hover { background: rgba(255,255,255,0.2); }
        .mod-primary { background: #0079bf; color: white; }
    </style>
</head>
<body onclick="closeAllMenus()">
    <div id="auth-section" class="hidden" style="padding: 20px; text-align: center;">
        <button id="auth-btn" class="mod-primary">Connect Trello</button>
    </div>

    <div id="main-content" class="hidden">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">Add Task</button>
            <button id="add-sub">Add Sub-task</button>
        </div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe({
          appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
          appName: 'Process Checklist'
        });

        var boardMembers = [];

        function closeAllMenus() {
            document.querySelectorAll('.member-menu').forEach(m => m.remove());
        }

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    t.sizeTo(120);
                } else {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    return t.board('members').then(function(m){
                        boardMembers = m.members;
                        return renderChecklist();
                    });
                }
            });
        });

        function renderChecklist() {
            return t.get('card', 'shared', 'checklistData', [])
            .then(function(data){
                const listDiv = document.getElementById('list');
                listDiv.innerHTML = '';
                
                data.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item' + (item.isSub ? ' indent' : '');
                    
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = item.checked || false;
                    cb.onchange = () => { item.checked = cb.checked; saveAndSync(data); };

                    const txt = document.createElement('input');
                    txt.className = 'task-input';
                    txt.value = item.text || '';
                    txt.placeholder = "Add an item...";
                    txt.onblur = () => { item.text = txt.value; saveAndSync(data); };

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';

                    // 1. Member Picker (Avatar or Star)
                    const memWrap = document.createElement('div');
                    memWrap.className = 'control-wrapper';
                    const assigned = boardMembers.find(m => m.id === item.idMember);
                    
                    if (assigned) {
                        const avatarSrc = assigned.avatarUrl ? assigned.avatarUrl + '/30.png' : null;
                        memWrap.innerHTML = avatarSrc ? `<img class="avatar" src="${avatarSrc}">` : `<div class="avatar">${assigned.initials}</div>`;
                    } else {
                        memWrap.innerHTML = '<span class="star-icon">‚≠ê</span>'; 
                    }

                    memWrap.onclick = (e) => {
                        e.stopPropagation();
                        closeAllMenus();
                        const menu = document.createElement('div');
                        menu.className = 'member-menu';
                        
                        // "None" option
                        const noneOpt = document.createElement('div');
                        noneOpt.className = 'member-option';
                        noneOpt.innerHTML = `<div class="avatar">?</div><span class="member-name">None</span>`;
                        noneOpt.onclick = () => { item.idMember = null; saveAndSync(data); };
                        menu.appendChild(noneOpt);

                        boardMembers.forEach(m => {
                            const opt = document.createElement('div');
                            opt.className = 'member-option';
                            const img = m.avatarUrl ? `<img class="avatar" src="${m.avatarUrl}/30.png">` : `<div class="avatar">${m.initials}</div>`;
                            opt.innerHTML = `${img}<span class="member-name">${m.fullName}</span>`;
                            opt.onclick = () => { item.idMember = m.id; saveAndSync(data); };
                            menu.appendChild(opt);
                        });
                        memWrap.appendChild(menu);
                    };

                    // 2. Date Picker
                    const dateWrap = document.createElement('div');
                    dateWrap.className = 'control-wrapper';
                    dateWrap.innerHTML = '<span class="date-icon">üìÖ</span>';
                    const dateInp = document.createElement('input');
                    dateInp.type = 'date';
                    dateInp.className = 'date-input-overlay';
                    dateInp.value = item.dueDate || '';
                    dateInp.onchange = () => { item.dueDate = dateInp.value; saveAndSync(data); };
                    dateWrap.appendChild(dateInp);

                    // 3. Delete
                    const del = document.createElement('div');
                    del.className = 'control-wrapper delete-btn';
                    del.innerHTML = '<span>‚ùå</span>';
                    del.onclick = (e) => { e.stopPropagation(); data.splice(i, 1); saveAndSync(data); };

                    controls.append(memWrap, dateWrap, del);
                    div.append(cb, txt, controls);
                    listDiv.appendChild(div);
                });
                
                setTimeout(() => t.sizeTo('body'), 50);
            });
        }

        async function saveAndSync(data) {
            await t.set('card', 'shared', 'checklistData', data);
            renderChecklist(); 
        }

        document.getElementById('add-main').onclick = () => addItem(false);
        document.getElementById('add-sub').onclick = () => addItem(true);

        function addItem(isSub) {
            t.get('card', 'shared', 'checklistData', [])
            .then(data => {
                data = data || [];
                data.push({ text: '', checked: false, isSub: isSub });
                return t.set('card', 'shared', 'checklistData', data);
            })
            .then(() => renderChecklist());
        }

        document.getElementById('auth-btn').onclick = function() {
            t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
        };
    </script>
</body>
</html>
