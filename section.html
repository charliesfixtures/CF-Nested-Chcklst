<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        /* 1. Remove scroll and match native Trello feel */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif;
            padding: 0; 
            margin: 0; 
            background: transparent; 
            color: inherit;
            overflow: hidden; /* Removes the scrollbar */
        }

        #main-content { width: 100%; display: block; padding-bottom: 8px; }

        /* 2. Checklist Item Styling */
        .item { 
            margin: 0; 
            display: flex; 
            align-items: center; 
            padding: 4px 8px;
            position: relative;
            group: hover;
        }
        
        .item:hover { background: rgba(255,255,255,0.05); border-radius: 3px; }

        .indent { margin-left: 28px; border-left: 2px solid #5e6c84; }

        input[type="checkbox"] { 
            cursor: pointer; 
            margin-right: 12px; 
            width: 16px;
            height: 16px;
        }

        /* 3. Match Native Font Size (14px) and Remove Borders */
        input[type="text"] { 
            border: none; 
            background: transparent; 
            width: 100%; 
            padding: 4px 0; 
            color: inherit; 
            font-size: 14px; /* Native size */
            line-height: 20px;
            outline: none;
        }
        
        input[type="text"]:focus { 
            background: rgba(255,255,255,0.1);
            box-shadow: inset 0 0 0 2px #0079bf;
            border-radius: 3px;
            padding-left: 4px;
        }

        /* 4. Delete Button (Hidden until hover) */
        .delete-btn {
            display: none;
            color: #888;
            cursor: pointer;
            padding: 0 8px;
            font-size: 18px;
            font-weight: bold;
        }

        .item:hover .delete-btn { display: block; }
        .delete-btn:hover { color: #eb5a46; }

        .footer { margin-top: 8px; padding: 8px; }
        .hidden { display: none !important; }
        
        button { 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: inherit; 
            padding: 6px 12px; 
            border-radius: 3px; 
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: rgba(255,255,255,0.2); }
        .mod-primary { background: #0079bf; color: white; }
        .mod-primary:hover { background: #005a8f; }
    </style>
</head>
<body>
    <div id="auth-section" class="hidden">
        <button id="auth-btn" class="mod-primary">Connect Trello</button>
    </div>

    <div id="main-content">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">Add Task</button>
            <button id="add-sub">Add Sub-task</button>
        </div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe({
          appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
          appName: 'Process Checklist'
        });

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    t.sizeTo(100);
                } else {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    renderChecklist();
                }
            });
        });

        function renderChecklist() {
            return t.get('card', 'shared', 'checklistData', [])
            .then(function(data){
                const listDiv = document.getElementById('list');
                listDiv.innerHTML = '';
                
                if(data && data.length > 0) {
                    data.forEach((item, i) => {
                        const div = document.createElement('div');
                        div.className = 'item' + (item.isSub ? ' indent' : '');
                        
                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.checked = item.checked || false;
                        cb.onchange = () => { item.checked = cb.checked; save(data); };

                        const txt = document.createElement('input');
                        txt.type = 'text';
                        txt.value = item.text || '';
                        txt.placeholder = "Item name...";
                        txt.onblur = () => { item.text = txt.value; save(data); };

                        // Delete button
                        const del = document.createElement('span');
                        del.className = 'delete-btn';
                        del.innerHTML = '&times;';
                        del.onclick = () => {
                            data.splice(i, 1); // Remove from array
                            save(data);
                        };

                        div.append(cb, txt, del);
                        listDiv.appendChild(div);
                    });
                }
                // The magic line to remove scrollbars:
                return t.sizeTo('#main-content').catch(e => {});
            });
        }

        function save(data) {
            return t.set('card', 'shared', 'checklistData', data).then(() => renderChecklist());
        }

        document.getElementById('add-main').onclick = () => addItem(false);
        document.getElementById('add-sub').onclick = () => addItem(true);

        function addItem(isSub) {
            t.get('card', 'shared', 'checklistData', [])
            .then(data => {
                data = data || [];
                data.push({ text: '', checked: false, isSub: isSub });
                return t.set('card', 'shared', 'checklistData', data);
            })
            .then(() => renderChecklist());
        }

        document.getElementById('auth-btn').onclick = function() {
            t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
        };
    </script>
</body>
</html>
