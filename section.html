<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif;
            padding: 0; margin: 0; background: transparent; color: inherit; overflow: hidden; 
        }

        #main-content { padding-bottom: 8px; }

        .item { 
            display: flex; align-items: center; padding: 2px 8px; position: relative; min-height: 32px;
        }
        .item:hover { background: rgba(255,255,255,0.08); border-radius: 3px; }
        .indent { margin-left: 24px; border-left: 2px solid #5e6c84; }

        input[type="checkbox"] { cursor: pointer; margin-right: 12px; width: 16px; height: 16px; flex-shrink: 0; }

        .task-input { 
            border: none; background: transparent; flex: 1; padding: 4px 0; 
            color: inherit; font-size: 14px; outline: none; min-width: 0;
        }

        /* Tightened Icon Row */
        .item-controls {
            display: flex; align-items: center; opacity: 0; transition: opacity 0.15s;
            margin-left: 4px; flex-shrink: 0;
        }
        .item:hover .item-controls { opacity: 1; }

        .control-wrapper {
            position: relative; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-left: 2px; /* Reduced gap */
        }

        .control-wrapper span { font-size: 14px; pointer-events: none; z-index: 1; opacity: 0.7; }

        .control-wrapper select, 
        .control-wrapper input[type="date"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; z-index: 2; border: none;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            margin: 0; padding: 0; cursor: pointer;
        }

        .delete-btn span { font-size: 18px; font-weight: bold; }
        .delete-btn:hover span { color: #eb5a46; opacity: 1; }

        .footer { padding: 8px; display: flex; gap: 8px; }
        .hidden { display: none !important; }
        
        button { 
            background: rgba(255,255,255,0.1); border: none; color: inherit; 
            padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 14px;
        }
        button:hover { background: rgba(255,255,255,0.2); }
        .mod-primary { background: #0079bf; color: white; }
    </style>
</head>
<body>
    <div id="auth-section" class="hidden" style="padding: 20px; text-align: center;">
        <button id="auth-btn" class="mod-primary">Connect Trello to Nested Checklist</button>
    </div>

    <div id="main-content" class="hidden">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">Add Task</button>
            <button id="add-sub">Add Sub-task</button>
        </div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe({
          appKey: 'YOUR_API_KEY_HERE',
          appName: 'Process Checklist'
        });

        var boardMembers = [];

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    t.sizeTo(120);
                } else {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    
                    return t.board('members').then(function(m){
                        boardMembers = m.members;
                        return renderChecklist();
                    });
                }
            });
        });

        function renderChecklist() {
            return t.get('card', 'shared', 'checklistData', [])
            .then(function(data){
                const listDiv = document.getElementById('list');
                listDiv.innerHTML = '';
                
                data.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item' + (item.isSub ? ' indent' : '');
                    
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = item.checked || false;
                    cb.onchange = () => { item.checked = cb.checked; saveAndSync(data); };

                    const txt = document.createElement('input');
                    txt.className = 'task-input';
                    txt.value = item.text || '';
                    txt.placeholder = "Add an item...";
                    txt.onblur = () => { item.text = txt.value; saveAndSync(data); };

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';

                    // 1. Member
                    const memWrap = document.createElement('div');
                    memWrap.className = 'control-wrapper';
                    memWrap.innerHTML = '<span>ðŸ‘¤</span>'; 
                    const sel = document.createElement('select');
                    sel.innerHTML = '<option value="">Assign</option>';
                    boardMembers.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.text = m.initials || m.fullName;
                        if(item.idMember === m.id) opt.selected = true;
                        sel.appendChild(opt);
                    });
                    sel.onchange = () => { item.idMember = sel.value; saveAndSync(data); };
                    memWrap.appendChild(sel);

                    // 2. Date
                    const dateWrap = document.createElement('div');
                    dateWrap.className = 'control-wrapper';
                    dateWrap.innerHTML = '<span>ðŸ•’</span>';
                    const date = document.createElement('input');
                    date.type = 'date';
                    date.value = item.dueDate || '';
                    date.onchange = () => { item.dueDate = date.value; saveAndSync(data); };
                    dateWrap.appendChild(date);

                    // 3. Delete
                    const del = document.createElement('div');
                    del.className = 'control-wrapper delete-btn';
                    del.innerHTML = '<span>&times;</span>';
                    del.onclick = () => { data.splice(i, 1); saveAndSync(data); };

                    controls.append(memWrap, dateWrap, del);
                    div.append(cb, txt, controls);
                    listDiv.appendChild(div);
                });
                
                // Use a slight delay to ensure the DOM is painted before sizing
                setTimeout(() => t.sizeTo('body'), 50);
            });
        }

        async function saveAndSync(data) {
            await t.set('card', 'shared', 'checklistData', data);
            renderChecklist(); 
            // Put your Sync-to-Native logic call here if you've already implemented it
        }

        document.getElementById('add-main').onclick = () => addItem(false);
        document.getElementById('add-sub').onclick = () => addItem(true);

        function addItem(isSub) {
            t.get('card', 'shared', 'checklistData', [])
            .then(data => {
                data = data || [];
                data.push({ text: '', checked: false, isSub: isSub });
                return t.set('card', 'shared', 'checklistData', data);
            })
            .then(() => renderChecklist());
        }

        document.getElementById('auth-btn').onclick = function() {
            t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
        };
    </script>
</body>
</html>
