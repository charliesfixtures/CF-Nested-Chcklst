<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif; padding: 0; margin: 0; background: transparent; color: inherit; overflow: visible; }
        #main-content { padding-bottom: 20px; } 
        .item { display: flex; align-items: center; padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .task-input { flex: 1; font-size: 14px; font-weight: 500; color: inherit; }
        .item-controls { display: flex; align-items: center; margin-left: 8px; }
        .status-btn { font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 3px; margin-right: 4px; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; background: rgba(255,255,255,0.05); min-width: 14px; text-align: center; }
        .status-btn:hover { background: rgba(255,255,255,0.2); }
        .hidden { display: none !important; }
        button { background: #0079bf; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; font-weight: bold; }
        .is-checked { opacity: 0.4; filter: grayscale(1); }
    </style>
</head>
<body>
    <div id="auth-section" class="hidden" style="padding: 20px; text-align: center;">
        <button id="auth-btn">Connect Trello Attendance</button>
    </div>
    <div id="main-content" class="hidden">
        <div id="list"></div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe({
          appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
          appName: 'Daily Attendance'
        });

        const REGISTRY_BOARD_ID = '6965633f4fe5254c47e38527';
        const MASTER_LIST_NAME = "2026 Employee"; 

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    t.sizeTo(120);
                } else {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    return renderAttendanceList();
                }
            });
        });
        
        function renderAttendanceList() {
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = '<div style="padding:15px;">üîç Syncing with Registry...</div>';

            // We use t.restApi here - this is the standard way to fetch data
            return t.restApi('GET', `/boards/${REGISTRY_BOARD_ID}/lists`)
            .then(function(lists) {
                const masterList = lists.find(l => l.name === MASTER_LIST_NAME);

                if (!masterList) {
                    listDiv.innerHTML = `<div style="padding:15px; color:#eb5a46;">List "${MASTER_LIST_NAME}" not found on Registry Board.</div>`;
                    t.sizeTo('body');
                    return;
                }

                return t.restApi('GET', `/lists/${masterList.id}/cards`);
            })
            .then(function(cards) {
                if (!cards) return;
                listDiv.innerHTML = ''; 

                cards.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    
                    const name = document.createElement('div');
                    name.className = 'task-input';
                    name.innerText = card.name;

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';

                    const statuses = [
                        { label: 'L', full: 'Late', color: '#f2d600' },
                        { label: 'A', full: 'Absent', color: '#eb5a46' },
                        { label: 'S', full: 'Sick', color: '#ff9f1a' },
                        { label: 'V', full: 'Vacation', color: '#0079bf' }
                    ];

                    statuses.forEach(s => {
                        const btn = document.createElement('div');
                        btn.className = 'status-btn';
                        btn.style.color = s.color;
                        btn.style.borderColor = s.color;
                        btn.innerText = s.label;
                        
                        btn.onclick = function() {
                            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            return t.restApi('POST', `/cards/${card.id}/actions/comments`, { 
                                text: `Logged: ${s.full} on ${today}` 
                            })
                            .then(() => {
                                t.alert({ message: `Logged ${s.full} for ${card.name}`, display: 'success' });
                                div.classList.add('is-checked');
                            })
                            .catch(() => t.alert({ message: "Failed to log", display: 'error' }));
                        };
                        controls.appendChild(btn);
                    });
                    
                    div.append(name, controls);
                    listDiv.appendChild(div);
                });
                t.sizeTo('body');
            })
            .catch(function(err) {
                console.error("Registry Load Error:", err);
                listDiv.innerHTML = `<div style="padding:15px;">Error connecting. <button onclick="location.reload()">Retry</button></div>`;
            });
        }

        document.getElementById('auth-btn').onclick = function() {
            t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
        };
    </script>
</body>
</html>
