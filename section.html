<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif;
            padding: 0; margin: 0; background: transparent; color: inherit; overflow: visible; 
        }

        #main-content { padding-bottom: 60px; } 

        .item { 
            display: flex; align-items: center; padding: 4px 8px; position: relative; min-height: 32px;
        }
        .item:hover { background: rgba(255,255,255,0.08); border-radius: 3px; }
        .indent { margin-left: 24px; border-left: 2px solid #5e6c84; }

        input[type="checkbox"] { cursor: pointer; margin-right: 12px; width: 16px; height: 16px; flex-shrink: 0; }

        .task-input { 
            border: none; background: transparent; flex: 1; padding: 4px 0; 
            color: inherit; font-size: 14px; outline: none; min-width: 0;
        }

        /* --- ACTION BAR --- */
        .item-controls {
            display: flex; align-items: center; margin-left: 8px; flex-shrink: 0;
        }

        /* Hide controls only if data is empty; if data exists, show it always */
        .control-wrapper {
            position: relative; display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-left: 6px; min-width: 24px; height: 24px;
        }

        /* Hide specific empty icons until hover */
        .is-empty { opacity: 0; transition: opacity 0.15s; }
        .item:hover .is-empty { opacity: 1; }

        /* Avatar Styling */
        .avatar {
            width: 24px; height: 24px; border-radius: 50%;
            background: #dfe1e6; display: flex; align-items: center;
            justify-content: center; font-size: 10px; font-weight: bold;
            color: #172b4d; overflow: hidden; object-fit: cover;
        }

        /* Date Badge Styling (Like Trello) */
        .date-badge {
            font-size: 12px; padding: 2px 6px; border-radius: 3px;
            background: rgba(255,255,255,0.15); display: flex; align-items: center; gap: 4px;
        }
        .date-badge:hover { background: rgba(255,255,255,0.25); }

        /* Member Picker Dropdown */
        .member-menu {
            position: absolute; top: 30px; right: 0; z-index: 1000;
            background: #ffffff; border-radius: 3px; 
            box-shadow: 0 8px 16px -4px rgba(9, 30, 66, 0.25), 0 0 0 1px rgba(9, 30, 66, 0.08);
            width: 220px; padding: 4px 0; color: #172b4d;
        }
        .member-option {
            display: flex; align-items: center; padding: 8px 12px; cursor: pointer;
        }
        .member-option:hover { background: #f4f5f7; }
        .member-option .avatar { margin-right: 10px; flex-shrink: 0; }

        /* Hidden Date Overlay */
        .date-input-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; z-index: 2;
        }

        .delete-btn { font-size: 16px; opacity: 0; margin-left: 8px; }
        .item:hover .delete-btn { opacity: 0.6; }
        .delete-btn:hover { opacity: 1; color: #eb5a46; }

        .footer { padding: 12px 8px; display: flex; gap: 8px; }
        .hidden { display: none !important; }
        
        button { 
            background: rgba(255,255,255,0.1); border: none; color: inherit; 
            padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 14px;
        }
        .mod-primary { background: #0079bf; color: white; }
    </style>
</head>
<body onclick="closeAllMenus()">
    <div id="auth-section" class="hidden" style="padding: 20px; text-align: center;">
        <button id="auth-btn" class="mod-primary">Connect Trello</button>
    </div>

    <div id="main-content" class="hidden">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">Add Task</button>
            <button id="add-sub">Add Sub-task</button>
        </div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe({
          appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
          appName: 'Process Checklist'
        });

        var boardMembers = [];

        function closeAllMenus() {
            document.querySelectorAll('.member-menu').forEach(m => m.remove());
        }

        function formatDate(dateStr) {
            if(!dateStr) return "";
            const d = new Date(dateStr);
            return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        }

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    t.sizeTo(120);
                } else {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                        return t.board('members', 'id', 'fullName', 'username', 'initials', 'avatar')
                        .then(function(m){
                        boardMembers = m.members;
                        return renderChecklist();
                    });
                }
            });
        });

        function getAvatarUrl(member) {
            if (member.avatarUrl) return `${member.avatarUrl}/30.png`;
            if (member.avatar) return `https://trello-avatars.s3.amazonaws.com/${member.avatar}/30.png`;
            return null; 
        }
        
        function renderChecklist() {
            return t.get('card', 'shared', 'checklistData', [])
            .then(function(data){
                const listDiv = document.getElementById('list');
                listDiv.innerHTML = '';
                
                data.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item' + (item.isSub ? ' indent' : '');
                    
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = item.checked || false;
                    cb.onchange = () => { item.checked = cb.checked; save(data); };

                    const txt = document.createElement('input');
                    txt.className = 'task-input';
                    txt.value = item.text || '';
                    txt.placeholder = "Add an item...";
                    txt.onblur = () => { item.text = txt.value; save(data); };

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';

                    // 1. DATE PICKER (Now on the Left)
                    const dateWrap = document.createElement('div');
                    dateWrap.className = 'control-wrapper' + (item.dueDate ? '' : ' is-empty');
                    
                    const dateDisplay = item.dueDate ? 
                        `<div class="date-badge">üìÖ ${formatDate(item.dueDate)}</div>` : 
                        `<span>üìÖ</span>`;
                    dateWrap.innerHTML = dateDisplay;

                    const dateInp = document.createElement('input');
                    dateInp.type = 'date';
                    dateInp.className = 'date-input-overlay';
                    dateInp.value = item.dueDate || '';
                    dateInp.onchange = () => { item.dueDate = dateInp.value; save(data); };
                    dateWrap.appendChild(dateInp);

                    // 2. MEMBER PICKER (Now on the Right)
                    const memWrap = document.createElement('div');
                    memWrap.className = 'control-wrapper' + (item.idMember ? '' : ' is-empty');
                    const assigned = boardMembers.find(m => m.id === item.idMember);
                    
                    if (assigned) {
                        const avatarUrl = getAvatarUrl(assigned); // Use our new helper
                        if (avatarUrl) {
                            // If they have a photo, show it!
                            memWrap.innerHTML = `<img class="avatar" src="${avatarUrl}" style="width:22px; height:22px; border-radius:50%; object-fit:cover;">`;
                        } else {
                            // If no photo, show the colored circle with initials
                            memWrap.innerHTML = `<div class="avatar" style="width:22px; height:22px; border-radius:50%; background:#dfe1e6; display:flex; align-items:center; justify-content:center; font-size:10px;">${assigned.initials}</div>`;
                        }
                    } else {
                    memWrap.innerHTML = '<span class="star-icon">‚≠ê</span>'; 
                    }
                    
                    memWrap.onclick = (e) => {
                        e.stopPropagation();
                        closeAllMenus();
                        const menu = document.createElement('div');
                        menu.className = 'member-menu';
                        
                        const noneOpt = document.createElement('div');
                        noneOpt.className = 'member-option';
                        noneOpt.innerHTML = <div class="avatar" style="background:#f4f5f7; color:#888;">?</div><span class="member-name">None</span>;
                        noneOpt.onclick = () => { item.idMember = null; save(data); };
                        menu.appendChild(noneOpt);

                        boardMembers.forEach(m => {
                            const opt = document.createElement('div');
                            opt.className = 'member-option';
                            const avatarUrl = getAvatarUrl(m); 
                            const img = avatarUrl ? `<img class="avatar" src="${avatarUrl}">` : `<div class="avatar">${m.initials}</div>`;
                            opt.innerHTML = `${img}<span class="member-name">${m.fullName}</span>`;
                            opt.onclick = () => { item.idMember = m.id; save(data); };
                            menu.appendChild(opt);
                        });
                        memWrap.appendChild(menu);
                    };

                    // 3. DELETE
                    const del = document.createElement('div');
                    del.className = 'delete-btn';
                    del.innerHTML = '‚ùå';
                    del.onclick = (e) => { e.stopPropagation(); data.splice(i, 1); save(data); };

                    controls.append(dateWrap, memWrap);
                    div.append(cb, txt, controls, del);
                    listDiv.appendChild(div);
                });
                
                setTimeout(() => t.sizeTo('body'), 50);
            });
        }

        async function save(data) {
            await t.set('card', 'shared', 'checklistData', data);
            renderChecklist(); 
        }

        document.getElementById('add-main').onclick = () => addItem(false);
        document.getElementById('add-sub').onclick = () => addItem(true);

        function addItem(isSub) {
            t.get('card', 'shared', 'checklistData', [])
            .then(data => {
                data = data || [];
                data.push({ text: '', checked: false, isSub: isSub });
                return t.set('card', 'shared', 'checklistData', data);
            })
            .then(() => renderChecklist());
        }

        document.getElementById('auth-btn').onclick = function() {
            t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
        };
    </script>
</body>
</html>
