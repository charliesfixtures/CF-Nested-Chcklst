<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 10px; color: #172b4d; }
        .loading { padding: 20px; text-align: center; color: #5e6c84; font-style: italic; }
        .item { display: flex; align-items: center; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid #ebecf0; }
        .name { font-size: 14px; font-weight: 600; flex: 1; }
        .btn-group { display: flex; gap: 6px; }
        .status-btn { 
            cursor: pointer; width: 24px; height: 24px; border-radius: 3px; border: 1px solid #dfe1e6; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; background: #fff;
        }
        .status-btn:hover { background: #f4f5f7; }
        .is-logged { opacity: 0.3; pointer-events: none; background: #f4f5f7; }
        .error-msg { color: #b04632; padding: 15px; background: #faf3f2; border-radius: 3px; font-size: 13px; }
    </style>
</head>
<body>
    <div id="list-container" class="loading">Loading...</div>

    <script>
        var t = TrelloPowerUp.iframe();

        const REGISTRY_BOARD_ID = '6965633f4fe5254c47e38527';
        const TARGET_LIST_NAME = "2026 Employee";

        t.render(function() {
            // First check authorization
            return t.getRestApi().isAuthorized()
                .then(function(isAuth) {
                    if (!isAuth) {
                        showAuthButton();
                    } else {
                        // Authorized! Now we can safely use restApi
                        loadRegistryData();
                    }
                })
                .catch(err => {
                    document.getElementById('list-container').innerHTML = `<div class="error-msg">Auth check failed: ${err.message}</div>`;
                });
        });

        function loadRegistryData() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div class="loading">Syncing with Registry...</div>';
            
            // This is the call that was failing
            t.restApi('GET', `/boards/${REGISTRY_BOARD_ID}/lists?cards=open&card_fields=name,id`)
                .then(function(lists) {
                    const masterList = lists.find(l => l.name === TARGET_LIST_NAME);
                    
                    if (!masterList) {
                        container.innerHTML = `<div class="error-msg">List "${TARGET_LIST_NAME}" not found on Registry Board.</div>`;
                        return;
                    }

                    if (masterList.cards.length === 0) {
                        container.innerHTML = `<div class="loading">No employees found in list "${TARGET_LIST_NAME}".</div>`;
                        return;
                    }

                    renderList(masterList.cards);
                })
                .catch(function(err) {
                    console.error("API Error:", err);
                    container.innerHTML = `<div class="error-msg">Cannot access Registry Board. Ensure authorized.</div>`;
                });
        }

        function renderList(cards) {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            cards.forEach(card => {
                const row = document.createElement('div');
                row.className = 'item';
                row.id = `card-${card.id}`;
                
                row.innerHTML = `
                    <div class="name">${card.name}</div>
                    <div class="btn-group">
                        <div class="status-btn" title="Late" style="color:#cf9f02" onclick="postLog('${card.id}', 'Late')">L</div>
                        <div class="status-btn" title="Absent" style="color:#b04632" onclick="postLog('${card.id}', 'Absent')">A</div>
                        <div class="status-btn" title="Sick" style="color:#d97008" onclick="postLog('${card.id}', 'Sick')">S</div>
                        <div class="status-btn" title="Vacation" style="color:#0052cc" onclick="postLog('${card.id}', 'Vacation')">V</div>
                    </div>
                `;
                container.appendChild(row);
            });
            t.sizeTo('body');
        }

        function postLog(cardId, status) {
            const dateStr = new Date().toLocaleDateString();
            t.restApi('POST', `/cards/${cardId}/actions/comments`, { 
                text: `**Attendance:** ${status} on ${dateStr}` 
            })
            .then(() => {
                document.getElementById(`card-${cardId}`).classList.add('is-logged');
                t.alert({ message: `Logged ${status}`, display: 'success' });
            })
            .catch(err => t.alert({ message: "Logging failed", display: 'error' }));
        }

        function showAuthButton() {
            document.getElementById('list-container').innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <p>Authorization required to sync boards.</p>
                    <button id="auth-btn" style="background:#0079bf; color:white; border:none; padding:8px 16px; border-radius:3px; cursor:pointer;">Authorize</button>
                </div>
            `;
            document.getElementById('auth-btn').addEventListener('click', function() {
                t.getRestApi().authorize({ scope: 'read,write' })
                    .then(() => location.reload());
            });
            t.sizeTo('body');
        }
    </script>
</body>
</html>
