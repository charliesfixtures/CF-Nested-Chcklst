<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
<style>
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif;
        padding: 0; margin: 0; background: transparent; color: inherit; overflow: hidden; 
    }

    #list { padding-top: 4px; }

    .item { 
        display: flex; align-items: center; padding: 4px 8px; position: relative; min-height: 32px;
    }
    
    .item:hover { background: rgba(255,255,255,0.08); border-radius: 3px; }

    .indent { margin-left: 24px; border-left: 2px solid #5e6c84; }

    input[type="checkbox"] { cursor: pointer; margin-right: 12px; width: 16px; height: 16px; }

    /* The task text */
    .task-input { 
        border: none; background: transparent; flex: 1; padding: 4px 0; 
        color: inherit; font-size: 14px; outline: none;
    }

    /* --- THE REVEAL MAGIC --- */
    .item-controls {
        display: flex; align-items: center; 
        opacity: 0; /* Completely hidden */
        transition: opacity 0.2s;
    }
    
    .item:hover .item-controls { opacity: 1; } /* Visible on hover */

    /* Individual control wrappers (no background boxes anymore) */
    .control-wrapper {
        display: flex; align-items: center; margin-left: 8px;
    }

    /* Stylizing pickers to look like pure icons */
    select, input[type="date"] {
        border: none; background: transparent; color: transparent; /* Hide text */
        cursor: pointer; outline: none; width: 20px; font-size: 14px;
        appearance: none; -webkit-appearance: none; /* Hide default dropdown arrow */
    }
    
    /* Make the icons themselves slightly visible */
    .control-wrapper span { opacity: 0.7; }
    .control-wrapper:hover span { opacity: 1; color: #0079bf; }

    /* Delete button (hidden until hover) */
    .delete-btn {
        margin-left: 8px; color: #888; cursor: pointer; font-size: 18px;
        visibility: hidden; padding: 0 4px;
    }
    .item:hover .delete-btn { visibility: visible; }
    .delete-btn:hover { color: #eb5a46; }

    .footer { padding: 12px 8px; }
    button { 
        background: rgba(255,255,255,0.1); border: none; color: inherit; 
        padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 14px;
    }
    button:hover { background: rgba(255,255,255,0.2); }
    .mod-primary { background: #0079bf; color: white; margin-right: 8px; }
</style>
</head>
    
<body>
    <div id="auth-section" class="hidden">
        <button id="auth-btn" class="mod-primary">Connect Trello</button>
    </div>

    <div id="main-content">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">Add Task</button>
            <button id="add-sub">Add Sub</button>
        </div>
    </div>

<script>
    var t = TrelloPowerUp.iframe({
      appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
      appName: 'Process Checklist'
    });

    var boardMembers = [];

    // --- INITIALIZATION ---
    t.render(function(){
        return t.getRestApi().isAuthorized()
        .then(function(authorized) {
            if (!authorized) {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
                t.sizeTo(100);
            } else {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // Fetch board members once so we can use them in dropdowns
                return t.board('members').then(function(m){
                    boardMembers = m.members;
                    return renderChecklist();
                });
            }
        });
    });

    function renderChecklist() {
        return t.get('card', 'shared', 'checklistData', [])
        .then(function(data){
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = '';
            
data.forEach((item, i) => {
    const div = document.createElement('div');
    div.className = 'item' + (item.isSub ? ' indent' : '');
    
    // Checkbox
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = item.checked || false;
    cb.onchange = () => { item.checked = cb.checked; saveAndSync(data); };

    // Text Input
    const txt = document.createElement('input');
    txt.className = 'task-input';
    txt.value = item.text || '';
    txt.placeholder = "Add an item...";
    txt.onblur = () => { item.text = txt.value; saveAndSync(data); };

    // Wrapper for Date & Member (the part that fades in)
    const controls = document.createElement('div');
    controls.className = 'item-controls';

    // Member Selector (styled as pure icon)
    const memWrap = document.createElement('div');
    memWrap.className = 'control-wrapper';
    memWrap.innerHTML = '<span>ðŸ‘¤</span>'; 
    const sel = document.createElement('select');
    sel.title = "Assign Member";
    sel.innerHTML = '<option value="">Assign</option>';
    boardMembers.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.text = m.initials || m.fullName;
        if(item.idMember === m.id) opt.selected = true;
        sel.appendChild(opt);
    });
    sel.onchange = () => { item.idMember = sel.value; saveAndSync(data); };
    memWrap.appendChild(sel);

    // Date Picker (styled as pure icon)
    const dateWrap = document.createElement('div');
    dateWrap.className = 'control-wrapper';
    dateWrap.innerHTML = '<span>ðŸ•’</span>';
    const date = document.createElement('input');
    date.type = 'date';
    date.title = "Set Due Date";
    date.value = item.dueDate || '';
    date.onchange = () => { item.dueDate = date.value; saveAndSync(data); };
    dateWrap.appendChild(date);

    // Delete
    const del = document.createElement('span');
    del.className = 'delete-btn';
    del.innerHTML = '&times;';
    del.title = "Delete Item";
    del.onclick = () => { data.splice(i, 1); saveAndSync(data); };

    controls.append(memWrap, dateWrap);
    div.append(cb, txt, controls, del);
    listDiv.appendChild(div);
});
            return t.sizeTo('#main-content').catch(e => {});
        });
    }

    // --- MIRRORING LOGIC ---
    async function saveAndSync(data) {
        // Save locally
        await t.set('card', 'shared', 'checklistData', data);
        
        // SYNC TO NATIVE (This triggers Butler)
        try {
            const card = await t.card('id', 'checklists');
            const token = await t.getRestApi().getToken();
            const key = await t.getRestApi().appKey;
            
            // 1. Find or Create "Automation Sync" checklist
            let nativeCl = card.checklists.find(c => c.name === "Automation Sync");
            if (!nativeCl) {
                const res = await fetch(`https://api.trello.com/1/checklists?idCard=${card.id}&name=Automation%20Sync&key=${key}&token=${token}`, { method: 'POST' });
                nativeCl = await res.json();
            }

            // 2. Clear native checklist items to refresh them (Simplest way to sync)
            for (let item of nativeCl.checkItems) {
                await fetch(`https://api.trello.com/1/checklists/${nativeCl.id}/checkItems/${item.id}?key=${key}&token=${token}`, { method: 'DELETE' });
            }

            // 3. Add current nested items to the native checklist
            for (let item of data) {
                if(!item.text) continue;
                let url = `https://api.trello.com/1/checklists/${nativeCl.id}/checkItems?name=${encodeURIComponent(item.text)}&key=${key}&token=${token}`;
                if(item.dueDate) url += `&due=${item.dueDate}`;
                if(item.idMember) url += `&idMember=${item.idMember}`;
                if(item.checked) url += `&state=complete`;
                
                await fetch(url, { method: 'POST' });
            }
        } catch (e) { console.error("Sync Error:", e); }

        renderChecklist();
    }

    // (Keep your Add/Auth button click handlers same as before)
</script>
    
</body>
</html>
