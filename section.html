<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif;
            padding: 0; margin: 0; background: transparent; color: inherit; overflow: visible; 
        }
        #main-content { padding-bottom: 60px; } 
        .item { display: flex; align-items: center; padding: 4px 8px; position: relative; min-height: 32px; }
        .item:hover { background: rgba(255,255,255,0.08); border-radius: 3px; }
        .indent { margin-left: 24px; border-left: 2px solid #5e6c84; }
        input[type="checkbox"] { cursor: pointer; margin-right: 12px; width: 16px; height: 16px; flex-shrink: 0; }
        .task-input { border: none; background: transparent; flex: 1; padding: 4px 0; color: inherit; font-size: 14px; outline: none; min-width: 0; }
        .item-controls { display: flex; align-items: center; margin-left: 8px; flex-shrink: 0; }
        .control-wrapper { position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 6px; min-width: 24px; height: 24px; }
        .is-empty { opacity: 0; transition: opacity 0.15s; }
        .item:hover .is-empty { opacity: 1; }
        .avatar { width: 24px; height: 24px; border-radius: 50%; background: #dfe1e6; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #172b4d; overflow: hidden; object-fit: cover; }
        .date-badge { font-size: 12px; padding: 2px 6px; border-radius: 3px; background: rgba(255,255,255,0.15); display: flex; align-items: center; gap: 4px; }
        .member-menu { position: absolute; top: 30px; right: 0; z-index: 1000; background: #ffffff; border-radius: 3px; box-shadow: 0 8px 16px -4px rgba(9,30,66,0.25), 0 0 0 1px rgba(9,30,66,0.08); width: 220px; padding: 4px 0; color: #172b4d; }
        .member-option { display: flex; align-items: center; padding: 8px 12px; cursor: pointer; }
        .member-option:hover { background: #f4f5f7; }
        .member-option .avatar { margin-right: 10px; flex-shrink: 0; }
        .date-input-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2; }
        .delete-btn { font-size: 16px; opacity: 0; margin-left: 8px; cursor: pointer; }
        .item:hover .delete-btn { opacity: 0.6; }
        .delete-btn:hover { opacity: 1; color: #eb5a46; }
        .footer { padding: 12px 8px; display: flex; gap: 8px; }
        .hidden { display: none !important; }
        button { background: rgba(255,255,255,0.1); border: none; color: inherit; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 14px; }
        .mod-primary { background: #0079bf; color: white; }
        .item.is-checked .task-input { text-decoration: line-through; opacity: 0.6; }
        .date-due-now, .date-overdue { color: #eb5a46 !important; font-weight: bold; }
        .date-soon { color: #f2d600 !important; font-weight: bold; }
    </style>
</head>
<body onclick="closeAllMenus()">
    <div id="auth-section" class="hidden" style="padding: 20px; text-align: center;">
        <button id="auth-btn" class="mod-primary">Connect Trello to Start</button>
    </div>

    <div id="main-content" class="hidden">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">+ Add Task</button>
            <button id="add-sub">+ Add Sub-task</button>
        </div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe({
            appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
            appName: 'Process Checklist'
        });

        const key = '8a3d78ec37dd6c8669e2f2f997f2e96e';
        const CHECKLIST_NAME = "Tasks";
        const MIRROR_BOARD_ID = '6996526f2424ecd5c7a1bda9';
        const MIRROR_LIST_NAME = 'To Do';
        const DONE_LIST_NAME = 'Done';

        var boardMembers = [];

        function closeAllMenus() { document.querySelectorAll('.member-menu').forEach(m => m.remove()); }

        function getAvatarUrl(member) {
            if (!member) return null;
            let source = member.avatarUrl || member.avatar;
            if (!source) return null;
            if (source.indexOf('http') === 0) return source.replace(/\/(50|170)\.png$/, '/30.png');
            return "https://trello-avatars.s3.amazonaws.com/" + source + "/30.png";
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        }

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                } else {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    // Get members once on load
                    return t.board('members').then(board => {
                        boardMembers = board.members || [];
                        renderChecklist();
                    });
                }
            }).catch(err => {
                console.error("Auth Error:", err);
            });
        });

        async function renderChecklist() {
            try {
                const card = await t.card('id');
                const token = await t.getRestApi().getToken();
                const checklists = await fetch(`https://api.trello.com/1/cards/${card.id}/checklists?key=${key}&token=${token}`).then(r => r.json());
                const mainList = checklists.find(c => c.name === CHECKLIST_NAME);
                
                if (!mainList) {
                    document.getElementById('list').innerHTML = '<p style="padding:10px; opacity:0.5;">No "Tasks" checklist found. Click Add Task to create one.</p>';
                    return t.sizeTo('body');
                }

                const meta = await t.get('card', 'shared', 'itemMeta_' + mainList.id, {});
                const listDiv = document.getElementById('list');
                listDiv.innerHTML = '';

                mainList.checkItems.sort((a,b) => a.pos - b.pos).forEach(item => {
                    const isSub = item.name.startsWith('   ');
                    const itemMeta = meta[item.id] || {};
                    const div = document.createElement('div');
                    div.className = 'item' + (isSub ? ' indent' : '') + (item.state === 'complete' ? ' is-checked' : '');

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = (item.state === 'complete');
                    cb.onclick = () => toggleCheck(mainList.id, item, itemMeta.mirrorCardId);

                    const txt = document.createElement('input');
                    txt.className = 'task-input';
                    txt.value = item.name.trim();
                    txt.onblur = () => updateText(mainList.id, item, txt.value, isSub, itemMeta.mirrorCardId);

                    const controls = document.createElement('div');
                    controls.className = 'item-controls';

                    const dateWrap = document.createElement('div');
                    dateWrap.className = 'control-wrapper' + (itemMeta.dueDate ? '' : ' is-empty');
                    dateWrap.innerHTML = itemMeta.dueDate ? `<div class="date-badge">ðŸ“… ${formatDate(itemMeta.dueDate)}</div>` : 'ðŸ“…';
                    
                    const dateInp = document.createElement('input');
                    dateInp.type = 'date';
                    dateInp.className = 'date-input-overlay';
                    dateInp.onchange = (e) => updateMirrorDate(mainList.id, item.id, e.target.value, itemMeta.mirrorCardId);
                    dateWrap.appendChild(dateInp);

                    const memWrap = document.createElement('div');
                    memWrap.className = 'control-wrapper' + (itemMeta.idMember ? '' : ' is-empty');
                    const assigned = boardMembers.find(m => m.id === itemMeta.idMember);
                    memWrap.innerHTML = assigned ? `<div class="avatar">${assigned.initials}</div>` : 'ðŸ‘¤';
                    memWrap.onclick = (e) => {
                        e.stopPropagation();
                        const menu = document.createElement('div');
                        menu.className = 'member-menu';
                        boardMembers.forEach(m => {
                            const opt = document.createElement('div');
                            opt.className = 'member-option';
                            opt.innerText = m.fullName;
                            opt.onclick = () => updateMirrorMember(mainList.id, item.id, m.id, itemMeta.mirrorCardId);
                            menu.appendChild(opt);
                        });
                        memWrap.appendChild(menu);
                    };

                    const del = document.createElement('div');
                    del.className = 'delete-btn';
                    del.innerHTML = 'âŒ';
                    del.onclick = () => deleteItem(mainList.id, item.id, itemMeta.mirrorCardId);

                    controls.append(dateWrap, memWrap);
                    div.append(cb, txt, controls, del);
                    listDiv.appendChild(div);
                });
                t.sizeTo('body');
            } catch (e) { console.error("Render Error:", e); }
        }

        async function addItem(isSub) {
            const token = await t.getRestApi().getToken();
            const card = await t.card('id', 'name');
            const checklists = await fetch(`https://api.trello.com/1/cards/${card.id}/checklists?key=${key}&token=${token}`).then(r => r.json());
            let list = checklists.find(c => c.name === CHECKLIST_NAME);
            if (!list) list = await fetch(`https://api.trello.com/1/checklists?idCard=${card.id}&name=${CHECKLIST_NAME}&key=${key}&token=${token}`, { method: 'POST' }).then(r => r.json());
            
            const name = isSub ? '   New Sub-task' : 'New Task';
            const item = await fetch(`https://api.trello.com/1/checklists/${list.id}/checkItems?name=${encodeURIComponent(name)}&key=${key}&token=${token}`, { method: 'POST' }).then(r => r.json());
            
            const toDoListId = await getListId(MIRROR_LIST_NAME);
            const mirrorCard = await fetch(`https://api.trello.com/1/cards?idList=${toDoListId}&name=${encodeURIComponent(name)}&key=${key}&token=${token}`, { method: 'POST' }).then(r => r.json());
            
            await saveMeta(list.id, item.id, 'mirrorCardId', mirrorCard.id);
            renderChecklist();
        }

        async function toggleCheck(listId, item, mirrorCardId) {
            const token = await t.getRestApi().getToken();
            const card = await t.card('id');
            const state = item.state === 'complete' ? 'incomplete' : 'complete';
            await fetch(`https://api.trello.com/1/cards/${card.id}/checklist/${listId}/checkItem/${item.id}?state=${state}&key=${key}&token=${token}`, { method: 'PUT' });
            if (mirrorCardId) {
                const targetListId = state === 'complete' ? await getListId(DONE_LIST_NAME) : await getListId(MIRROR_LIST_NAME);
                await fetch(`https://api.trello.com/1/cards/${mirrorCardId}?idList=${targetListId}&key=${key}&token=${token}`, { method: 'PUT' });
            }
            renderChecklist();
        }

        async function updateText(listId, item, newText, isSub, mirrorCardId) {
            const token = await t.getRestApi().getToken();
            const card = await t.card('id');
            const finalName = isSub ? '   ' + newText : newText;
            await fetch(`https://api.trello.com/1/cards/${card.id}/checklist/${listId}/checkItem/${item.id}?name=${encodeURIComponent(finalName)}&key=${key}&token=${token}`, { method: 'PUT' });
            if (mirrorCardId) await fetch(`https://api.trello.com/1/cards/${mirrorCardId}?name=${encodeURIComponent(newText)}&key=${key}&token=${token}`, { method: 'PUT' });
        }

        async function deleteItem(listId, itemId, mirrorCardId) {
            const token = await t.getRestApi().getToken();
            await fetch(`https://api.trello.com/1/checklists/${listId}/checkItems/${itemId}?key=${key}&token=${token}`, { method: 'DELETE' });
            if (mirrorCardId) await fetch(`https://api.trello.com/1/cards/${mirrorCardId}?closed=true&key=${key}&token=${token}`, { method: 'PUT' });
            renderChecklist();
        }

        async function updateMirrorDate(listId, itemId, dateStr, mirrorCardId) {
            const token = await t.getRestApi().getToken();
            await saveMeta(listId, itemId, 'dueDate', dateStr);
            if (mirrorCardId) await fetch(`https://api.trello.com/1/cards/${mirrorCardId}?due=${dateStr}&key=${key}&token=${token}`, { method: 'PUT' });
            renderChecklist();
        }

        async function updateMirrorMember(listId, itemId, memberId, mirrorCardId) {
            const token = await t.getRestApi().getToken();
            await saveMeta(listId, itemId, 'idMember', memberId);
            if (mirrorCardId) await fetch(`https://api.trello.com/1/cards/${mirrorCardId}?idMembers=${memberId}&key=${key}&token=${token}`, { method: 'PUT' });
            renderChecklist();
        }

        async function saveMeta(listId, itemId, field, value) {
            const meta = await t.get('card', 'shared', 'itemMeta_' + listId, {});
            if (!meta[itemId]) meta[itemId] = {};
            meta[itemId][field] = value;
            await t.set('card', 'shared', 'itemMeta_' + listId, meta);
        }

        async function getListId(listName) {
            const token = await t.getRestApi().getToken();
            const lists = await fetch(`https://api.trello.com/1/boards/${MIRROR_BOARD_ID}/lists?key=${key}&token=${token}`).then(r => r.json());
            const list = lists.find(l => l.name.toLowerCase() === listName.toLowerCase());
            return list ? list.id : null;
        }

        document.getElementById('add-main').onclick = () => addItem(false);
        document.getElementById('add-sub').onclick = () => addItem(true);
        document.getElementById('auth-btn').onclick = () => t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
    </script>
</body>
</html>
