<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        /* 1. Remove scroll and match native Trello feel */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif;
            padding: 0; 
            margin: 0; 
            background: transparent; 
            color: inherit;
            overflow: hidden; /* Removes the scrollbar */
        }

        #main-content { width: 100%; display: block; padding-bottom: 8px; }

        /* 2. Checklist Item Styling */
        .item { 
            margin: 0; 
            display: flex; 
            align-items: center; 
            padding: 4px 8px;
            position: relative;
            group: hover;
        }
        
        .item:hover { background: rgba(255,255,255,0.05); border-radius: 3px; }

        .indent { margin-left: 28px; border-left: 2px solid #5e6c84; }

        input[type="checkbox"] { 
            cursor: pointer; 
            margin-right: 12px; 
            width: 16px;
            height: 16px;
        }

        /* 3. Match Native Font Size (14px) and Remove Borders */
        input[type="text"] { 
            border: none; 
            background: transparent; 
            width: 100%; 
            padding: 4px 0; 
            color: inherit; 
            font-size: 14px; /* Native size */
            line-height: 20px;
            outline: none;
        }
        
        input[type="text"]:focus { 
            background: rgba(255,255,255,0.1);
            box-shadow: inset 0 0 0 2px #0079bf;
            border-radius: 3px;
            padding-left: 4px;
        }

        /* 4. Delete Button (Hidden until hover) */
        .delete-btn {
            display: none;
            color: #888;
            cursor: pointer;
            padding: 0 8px;
            font-size: 18px;
            font-weight: bold;
        }

        .item:hover .delete-btn { display: block; }
        .delete-btn:hover { color: #eb5a46; }

        .footer { margin-top: 8px; padding: 8px; }
        .hidden { display: none !important; }
        
        button { 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: inherit; 
            padding: 6px 12px; 
            border-radius: 3px; 
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: rgba(255,255,255,0.2); }
        .mod-primary { background: #0079bf; color: white; }
        .mod-primary:hover { background: #005a8f; }
    </style>
</head>
<body>
    <div id="auth-section" class="hidden">
        <button id="auth-btn" class="mod-primary">Connect Trello</button>
    </div>

    <div id="main-content">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">Add Task</button>
            <button id="add-sub">Add Sub</button>
        </div>
    </div>

<script>
    var t = TrelloPowerUp.iframe({
      appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
      appName: 'Process Checklist'
    });

    var boardMembers = [];

    // --- INITIALIZATION ---
    t.render(function(){
        return t.getRestApi().isAuthorized()
        .then(function(authorized) {
            if (!authorized) {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
                t.sizeTo(100);
            } else {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // Fetch board members once so we can use them in dropdowns
                return t.board('members').then(function(m){
                    boardMembers = m.members;
                    return renderChecklist();
                });
            }
        });
    });

    function renderChecklist() {
        return t.get('card', 'shared', 'checklistData', [])
        .then(function(data){
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = '';
            
            data.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'item' + (item.isSub ? ' indent' : '');
                
                // 1. Checkbox
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = item.checked || false;
                cb.onchange = () => { item.checked = cb.checked; saveAndSync(data); };

                // 2. Task Text
                const txt = document.createElement('input');
                txt.type = 'text';
                txt.value = item.text || '';
                txt.style.flex = "1";
                txt.onblur = () => { item.text = txt.value; saveAndSync(data); };

                // 3. Member Dropdown (Automation Friendly)
                const sel = document.createElement('select');
                sel.style.width = "80px";
                sel.style.fontSize = "11px";
                sel.innerHTML = '<option value="">User</option>';
                boardMembers.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.text = m.initials || m.fullName;
                    if(item.idMember === m.id) opt.selected = true;
                    sel.appendChild(opt);
                });
                sel.onchange = () => { item.idMember = sel.value; saveAndSync(data); };

                // 4. Date Picker (Automation Friendly)
                const date = document.createElement('input');
                date.type = 'date';
                date.value = item.dueDate || '';
                date.style.width = "110px";
                date.onchange = () => { item.dueDate = date.value; saveAndSync(data); };

                // 5. Delete
                const del = document.createElement('span');
                del.className = 'delete-btn';
                del.innerHTML = '&times;';
                del.onclick = () => { data.splice(i, 1); saveAndSync(data); };

                div.append(cb, txt, sel, date, del);
                listDiv.appendChild(div);
            });
            return t.sizeTo('#main-content').catch(e => {});
        });
    }

    // --- MIRRORING LOGIC ---
    async function saveAndSync(data) {
        // Save locally
        await t.set('card', 'shared', 'checklistData', data);
        
        // SYNC TO NATIVE (This triggers Butler)
        try {
            const card = await t.card('id', 'checklists');
            const token = await t.getRestApi().getToken();
            const key = await t.getRestApi().appKey;
            
            // 1. Find or Create "Automation Sync" checklist
            let nativeCl = card.checklists.find(c => c.name === "Automation Sync");
            if (!nativeCl) {
                const res = await fetch(`https://api.trello.com/1/checklists?idCard=${card.id}&name=Automation%20Sync&key=${key}&token=${token}`, { method: 'POST' });
                nativeCl = await res.json();
            }

            // 2. Clear native checklist items to refresh them (Simplest way to sync)
            for (let item of nativeCl.checkItems) {
                await fetch(`https://api.trello.com/1/checklists/${nativeCl.id}/checkItems/${item.id}?key=${key}&token=${token}`, { method: 'DELETE' });
            }

            // 3. Add current nested items to the native checklist
            for (let item of data) {
                if(!item.text) continue;
                let url = `https://api.trello.com/1/checklists/${nativeCl.id}/checkItems?name=${encodeURIComponent(item.text)}&key=${key}&token=${token}`;
                if(item.dueDate) url += `&due=${item.dueDate}`;
                if(item.idMember) url += `&idMember=${item.idMember}`;
                if(item.checked) url += `&state=complete`;
                
                await fetch(url, { method: 'POST' });
            }
        } catch (e) { console.error("Sync Error:", e); }

        renderChecklist();
    }

    // (Keep your Add/Auth button click handlers same as before)
</script>
    
</body>
</html>
