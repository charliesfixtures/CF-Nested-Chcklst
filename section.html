<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Noto Sans, Ubuntu, Droid Sans, "Helvetica Neue", sans-serif; padding: 0; margin: 0; background: transparent; color: inherit; overflow: visible; }
        #main-content { padding-bottom: 20px; } 
        .item { display: flex; align-items: center; padding: 4px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        input[type="checkbox"] { cursor: pointer; margin-right: 12px; width: 16px; height: 16px; }
        .task-input { flex: 1; font-size: 14px; font-weight: 500; }
        .item-controls { display: flex; align-items: center; margin-left: 8px; }
        .status-btn { font-size: 10px; font-weight: bold; padding: 2px 5px; border-radius: 3px; margin-right: 4px; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; background: rgba(255,255,255,0.05); width: 14px; text-align: center; }
        .status-btn:hover { background: rgba(255,255,255,0.2); }
        .hidden { display: none !important; }
        button { background: #0079bf; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; }
        .item.is-checked { opacity: 0.5; }
        .item.is-checked .task-input { text-decoration: line-through; }
    </style>
</head>
<body>
    <div id="auth-section" class="hidden" style="padding: 20px; text-align: center;">
        <button id="auth-btn">Connect Trello Attendance</button>
    </div>
    <div id="main-content" class="hidden">
        <div id="list"></div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe({
          appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
          appName: 'Daily Attendance'
        });

        const REGISTRY_BOARD_ID = '6965633f4fe5254c47e38527';
        const MASTER_LIST_NAME = "2026 Employee"; 

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    t.sizeTo(120);
                } else {
                    document.getElementById('main-content').classList.remove('hidden');
                    return renderAttendanceList();
                }
            });
        });
        
        async function renderAttendanceList() {
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = '<div style="padding:10px;">Syncing with Registry...</div>';

            try {
                // Corrected API syntax: t.restApi('METHOD', 'PATH')
                const boardLists = await t.restApi('GET', `/boards/${REGISTRY_BOARD_ID}/lists`);
                const masterList = boardLists.find(l => l.name === MASTER_LIST_NAME);

                if (!masterList) {
                    listDiv.innerHTML = `<div style="padding:10px; color:#eb5a46;">List "${MASTER_LIST_NAME}" not found.</div>`;
                    return;
                }

                const cards = await t.restApi('GET', `/lists/${masterList.id}/cards`);
                listDiv.innerHTML = ''; 

                cards.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    const name = document.createElement('span');
                    name.className = 'task-input';
                    name.innerText = card.name;
                    const controls = document.createElement('div');
                    controls.className = 'item-controls';

                    const statuses = ['Late', 'Absent', 'Sick', 'Vacation'];
                    const statusColors = { 'Late': '#f2d600', 'Absent': '#eb5a46', 'Sick': '#ff9f1a', 'Vacation': '#0079bf' };

                    statuses.forEach(status => {
                        const btn = document.createElement('div');
                        btn.className = 'status-btn';
                        btn.style.color = statusColors[status];
                        btn.style.borderColor = statusColors[status];
                        btn.innerText = status[0];
                        btn.onclick = async () => {
                            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            try {
                                await t.restApi('POST', `/cards/${card.id}/actions/comments`, { text: `Logged: ${status} on ${today}` });
                                t.alert({ message: `Success: ${card.name} - ${status}`, display: 'success' });
                                div.classList.add('is-checked');
                                cb.checked = true;
                            } catch (e) { t.alert({ message: "Log failed", display: 'error' }); }
                        };
                        controls.appendChild(btn);
                    });
                    div.append(cb, name, controls);
                    listDiv.appendChild(div);
                });
                t.sizeTo('body');
            } catch (err) {
                listDiv.innerHTML = `<div style="padding:10px;">Connection Error. <button onclick="location.reload()">Retry</button></div>`;
            }
        }

        document.getElementById('auth-btn').onclick = function() {
            t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
        };
    </script>
</body>
</html>
