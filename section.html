<!DOCTYPE html>
<html>
<head>
    <script src="https://p.trellocdn.com/power-up.min.js?key=8a3d78ec37dd6c8669e2f2f997f2e96e"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 10px; color: #172b4d; }
        .item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .name { font-size: 14px; font-weight: 600; flex: 1; }
        .btn-group { display: flex; gap: 4px; }
        .btn { cursor: pointer; padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px; background: #fff; font-size: 11px; font-weight: bold; }
        .hidden { display: none; }
        .mod-primary { background: #0079bf; color: white; border: none; padding: 10px; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="auth-section" class="hidden" style="text-align:center; padding:20px;">
        <button id="auth-btn" class="mod-primary">Authorize Attendance 2026</button>
    </div>

    <div id="main-content" class="hidden">
        <div id="attendance-list">Loading Employees...</div>
    </div>

    <script>
        // THIS WAS THE ERROR: We must pass the key and name here!
        var t = TrelloPowerUp.iframe({
            appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e',
            appName: 'Attendance 2026'
        });

        var REGISTRY_BOARD_ID = '6965633f4fe5254c47e38527';
        var TARGET_LIST_NAME = "2026 Employee";

        t.render(function(){
            return t.getRestApi().isAuthorized()
            .then(function(authorized) {
                if (!authorized) {
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    t.sizeTo(120);
                } else {
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    return fetchRegistryEmployees();
                }
            });
        });

        function fetchRegistryEmployees() {
            var listDiv = document.getElementById('attendance-list');

            return t.getRestApi().get('/boards/' + REGISTRY_BOARD_ID + '/lists', { cards: 'open' })
            .then(function(lists) {
                var masterList = lists.find(function(l) { return l.name === TARGET_LIST_NAME; });
                
                if (!masterList) {
                    listDiv.innerHTML = 'List "' + TARGET_LIST_NAME + '" not found.';
                    return;
                }

                var html = '';
                masterList.cards.forEach(function(card) {
                    html += '<div class="item" id="row-' + card.id + '">' +
                        '<div class="name">' + card.name + '</div>' +
                        '<div class="btn-group">' +
                            '<button class="btn" style="color:#cf9f02" onclick="log(\'' + card.id + '\', \'Late\')">L</button>' +
                            '<button class="btn" style="color:#b04632" onclick="log(\'' + card.id + '\', \'Absent\')">A</button>' +
                            '<button class="btn" style="color:#d97008" onclick="log(\'' + card.id + '\', \'Sick\')">S</button>' +
                            '<button class="btn" style="color:#0052cc" onclick="log(\'' + card.id + '\', \'Vacation\')">V</button>' +
                        '</div>' +
                    '</div>';
                });

                listDiv.innerHTML = html || 'No employees found.';
                t.sizeTo('body');
            })
            .catch(function(err) {
                listDiv.innerHTML = 'Error syncing. Check Registry Board access.';
            });
        }

        function log(cardId, status) {
            var date = new Date().toLocaleDateString();
            t.getRestApi().post('/cards/' + cardId + '/actions/comments', {
                text: 'Logged: ' + status + ' on ' + date
            })
            .then(function() {
                t.alert({ message: 'Success: ' + status, display: 'success' });
            });
        }

        document.getElementById('auth-btn').onclick = function() {
            t.getRestApi().authorize({ scope: 'read,write' })
            .then(function() { location.reload(); });
        };
    </script>
</body>
</html>
