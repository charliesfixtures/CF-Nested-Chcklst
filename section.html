<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; margin: 0; background: transparent; color: inherit; }
        #main-content { min-height: 50px; width: 100%; display: block; }
        .item { margin: 8px 0; display: flex; align-items: center; }
        .indent { margin-left: 25px; border-left: 2px solid #5e6c84; padding-left: 12px; }
        input[type="checkbox"] { cursor: pointer; margin-right: 12px; transform: scale(1.1); }
        input[type="text"] { 
            border: 1px solid transparent; background: transparent; 
            width: 100%; padding: 4px; color: inherit; font-size: 14px;
        }
        input[type="text"]:focus { background: rgba(255,255,255,0.1); border-radius: 3px; outline: none; }
        .footer { margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        button { cursor: pointer; }
    </style>
</head>
<body>
    <div id="auth-section" class="hidden">
        <button id="auth-btn" class="mod-primary">Connect Trello</button>
    </div>

    <div id="main-content">
        <div id="list"></div>
        <div class="footer">
            <button id="add-main" class="mod-primary">Add Task</button>
            <button id="add-sub" style="margin-left:8px;">Add Sub-task</button>
        </div>
    </div>

<script>
    // 1. Initialize with your Key
    var t = TrelloPowerUp.iframe({
      appKey: '8a3d78ec37dd6c8669e2f2f997f2e96e', // <--- PASTE YOUR KEY HERE
      appName: 'Process Checklist'
    });

    t.render(function(){
      // We wrap the auth check in a try/catch so even if it fails, 
      // the checklist still tries to load.
      try {
        return t.getRestApi().isAuthorized()
        .then(function(authorized) {
            if (!authorized) {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
                t.sizeTo(100);
            } else {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                renderChecklist();
            }
        })
        .catch(function(e) { 
            console.log("Auth helper skipped, loading list directly.");
            document.getElementById('main-content').classList.remove('hidden');
            renderChecklist(); 
        });
      } catch (e) {
        document.getElementById('main-content').classList.remove('hidden');
        renderChecklist();
      }
    });

    // 3. Auth Button
    document.getElementById('auth-btn').onclick = function() {
        t.getRestApi().authorize({ scope: 'read,write' }).then(() => location.reload());
    };

    // 4. Draw the items
    function renderChecklist() {
        return t.get('card', 'shared', 'checklistData', [])
        .then(function(data){
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = '';
            
            if(!data || data.length === 0) {
                listDiv.innerHTML = '<p style="color:#888; font-style:italic;">No tasks yet.</p>';
            } else {
                data.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item' + (item.isSub ? ' indent' : '');
                    
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = item.checked || false;
                    cb.onchange = () => { item.checked = cb.checked; save(data); };

                    const txt = document.createElement('input');
                    txt.type = 'text';
                    txt.value = item.text || '';
                    txt.onblur = () => { item.text = txt.value; save(data); };

                    div.append(cb, txt);
                    listDiv.appendChild(div);
                });
            }
            t.sizeTo('#main-content').catch(e => {});
        });
    }

    function save(data) {
        return t.set('card', 'shared', 'checklistData', data).then(() => renderChecklist());
    }

    document.getElementById('add-main').onclick = () => addItem(false);
    document.getElementById('add-sub').onclick = () => addItem(true);

    function addItem(isSub) {
        t.get('card', 'shared', 'checklistData', [])
        .then(data => {
            data = data || [];
            data.push({ text: '', checked: false, isSub: isSub });
            return t.set('card', 'shared', 'checklistData', data);
        })
        .then(() => renderChecklist());
    }
</script>
</body>
</html>
